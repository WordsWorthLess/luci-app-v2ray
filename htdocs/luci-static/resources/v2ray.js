/**
 * @license
 * Copyright 2020 Xingwang Liao <kuoruan@gmail.com>
 *
 * Licensed to the public under the MIT License.
 */
"use strict";"require fs";"require network";"require uci";return L.Class.extend({getLocalIPs:function(){return network.getNetworks().then((function(r){for(var e=["127.0.0.1","0.0.0.0","::"],t=0,a=r;t<a.length;t++){var n=a[t],i=n.getIPAddr(),s=n.getIP6Addr();i&&(i=i.split("/")[0])&&e.indexOf(i)<0&&e.push(i),s&&(s=s.split("/")[0])&&e.indexOf(s)<0&&e.push(s)}return e.sort()}))},getCore:function(){return uci.load("v2ray").then((function(){var r=uci.get("v2ray","main","core");r||(r="V2Ray")}))},getSections:function(r,e){return void 0===e&&(e="alias"),uci.load("v2ray").then((function(){var t=[];return uci.sections("v2ray",r,(function(r){var a=r[e];a&&t.push({caption:a,value:r[".name"]})})),t}))},getDokodemoDoorPorts:function(){return uci.load("v2ray").then((function(){var r=[];return uci.sections("v2ray","inbound",(function(e){var t;if("dokodemo-door"==e.protocol&&(t=e.port)){var a;(a=e.alias)?r.push({caption:"%s - %s".format(a,t),value:t}):r.push({caption:"%s:%s".format(e.listen,t),value:t})}})),r}))},getXtlsSecurity:function(){return uci.load("v2ray").then((function(){var r=[];return uci.sections("v2ray","v2ray",(function(e){"Xray"==e.core&&("1"==e.reality?r.push({security:["reality|REALITY"],flow:["xtls-rprx-vision","xtls-rprx-vision-udp443"]}):r.push({security:["xtls|XTLS"],flow:["xtls-rprx-direct","xtls-rprx-direct-udp443","xtls-rprx-origin","xtls-rprx-origin-udp443","xtls-rprx-splice","xtls-rprx-splice-udp443"]}))})),r}))},domainRule:function(r,e){void 0===e&&(e=!1);var t=/^localhost$/i,a=/^((?!-)[A-Za-z0-9-]{1,63}(?<!-)\.)+[A-Za-z]{2,6}$/;if(e)return!(!r.match(a)&&!r.match(t));if(r.match(a))return!0;if(r.match(t))return!0;var n=r.match(/^(\S+):(\S+)$/);if(n)switch(n[1]){case"domain":if(n[2].match(a))return!0;break;case"geosite":if(n[2].match(/^[a-zA-Z][a-zA-Z!-@.]*[a-zA-Z]$/))return!0;break;case"regexp":if(0!==n[2].length)try{return new RegExp(n[2]),!0}catch(r){return!1}break;case"keyword":if(n[2].match(/^[a-zA-Z0-9-.]+$/))return!0;break;default:return!1}return!1},ipRule:function(r,e){if(void 0===e&&(e=!1),e){for(var t=0,a=r.split(",");t<a.length;t++){var n=a[t];if(!(n.length>0))return!1;var i=validation.parseIPv4(n),s=validation.parseIPv6(n);if(null===i&&null===s)return!1}return!0}i=validation.parseIPv4(r),s=validation.parseIPv6(r);if(null!=i||null!=s)return!0;var o=r.split("/");if(!o||2!=o.length)return!!r.match(/^geoip:[a-zA-Z]{2}[a-zA-Z0-9@!-]*(?<![@!0-9-])$/);var u=validation.parseIPv4(o[0]),l=validation.parseIPv6(o[0]);return!!(u&&0<=parseInt(o[1])&&parseInt(o[1])<=32||l&&0<=parseInt(o[1])&&parseInt(o[1])<=128)},v2rayValidation:function(r,e){switch(r){case"wg-keys":return null!==e.match("^[a-zA-Z0-9/+]+=?=?$")&&e.length%4==0&&44===e.length||_("Invalid WireGuard key");case"wg-reserved":var t=e.match(/^(\d{1,3}),(\d{1,3}),(\d{1,3})$/);if(!t)return"%s:\n- %s\n  %s".format(_("Expecting"),_("'value1,value2,value3'"),_("each value should be an integer between 0-255"));var a=t.map(Number);return!![a[1],a[2],a[3]].every((function(r){return r>=0&&r<=255}))||"%s:\n- %s\n  %s".format(_("Expecting"),_("'value1,value2,value3'"),_("each value should be an integer between 0-255"));case"fragment-length":if(/^\d+$/.test(e)&&parseInt(e)>0)return!0;var n=e.split("-"),i=parseInt(n[0]),s=parseInt(n[1]);return i>0&&s>i||"%s: %s:\n- %s\n- %s".format(_("Expecting"),_("One of the following"),_("Integers greater than 0"),_("A range of integers which are greater than 0"));case"fragment-interval":if(/^\d+$/.test(e)&&parseInt(e)>0)return!0;if(/^\d+-\d+$/.test(e)){var o=e.split("-"),u=parseInt(o[0]),l=parseInt(o[1]);if(u>0&&l>u)return!0}return"%s: %s:\n- %s\n- %s".format(_("Expecting"),_("One of the following"),_("Integers greater than 0"),_("A range of integers which are greater than 0"));case"fragment-packets":if(/^\d+$/.test(e)&&parseInt(e)>0)return!0;if(/^\d+-\d+$/.test(e)){var c=e.split("-"),p=parseInt(c[0]),f=parseInt(c[1]);if(p>0&&f>p)return!0}return"tlshello"===e||"%s: %s:\n - %s\n   %s\n - %s\n   %s".format(_("Expecting"),_("One of the following"),_("Integers greater than 0, corresponding to the packet index"),_("eg: '5' for the fifth packet'"),_("A range of integers which are greater than 0"),_("eg: '1-3' for the 1st to 3rd packets"));case"hostmapping":var d=e.match(/^(\S+):(\S+)$/);if(d)if(this.domainRule(d[1])){var v=this.domainRule(d[2],!0),g=this.ipRule(d[2],!0);if(v||g)return!0}return"%s: %s:\n - %s\n   %s\n - %s\n   %s".format(_("Expecting"),"domain_structure|mapping_structure",_("valid domain structures:"),"<abbr>domain:domain.name</abbr> or <abbr>keyword:keywords</abbr> or <abbr>geosite:geosite_catagory</abbr> or <abbr>regexp:regular_expression</abbr>",_("valid mapping structures"),"<abbr>IP_address</abbr> or <abbr>IP_address,IP_address,...,IP_address</abbr> or <abbr>domain.name</abbr>");default:return _("Unknown Data")}}});